<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TaskSync Designer – PersonaFit v3.6.0 (Day/Week/Month)</title>
<meta name="color-scheme" content="light dark" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">
<style>
:root{
  --bg:#f7f9fc;--fg:#0f172a;--card:#fff;--muted:#64748b;
  --rail:#eef2f7;--railBorder:#e6ebf2;--border:#e6ebf2;
  --gap:10px; --pad:8px; --radius:12px; --small:12px;
  --proj-h:20px; --task-h:12px;
}
.dark{--bg:#0b0f14;--fg:#e5e7eb;--card:#0f172a;--muted:#9aa7b8;--rail:#1f2937;--railBorder:#2a3443;--border:#223041}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1280px;margin:0 auto;padding:12px}
h1{margin:0 0 6px;font-size:18px}
.toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--fg);cursor:pointer}
.btn.primary{background:#4f46e5;border-color:#4f46e5;color:#fff}
.btn.warn{background:#ef4444;border-color:#ef4444;color:#fff}
.btn.small{font-size:12px;padding:4px 8px}
.chip{padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
.chip.active{background:#4f46e5;border-color:#4f46e5;color:#fff}
select,input,textarea{font:inherit;color:inherit;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px}
input[list]{background:#fff}
textarea{min-height:64px;resize:vertical}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.lbl{display:block;color:var(--muted);margin-bottom:3px;font-size:12px}
.summary{display:flex;gap:6px;flex-wrap:wrap}
.pill{border:1px solid var(--border);border-radius:999px;padding:3px 10px;background:#fff;font-size:12px}

/* Layout */
.layout{display:grid;grid-template-columns:260px 1fr;grid-template-areas:"nav days" "nav main" "nav detail";gap:12px}
@media(max-width:1100px){.layout{grid-template-columns:1fr;grid-template-areas:"nav" "days" "main" "detail"}}
#nav{grid-area:nav}
.daysCard{grid-area:days}
.main{grid-area:main}
.detailArea{grid-area:detail}

/* Days header */
.days{display:grid;gap:4px;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);align-items:end}
.day{font-size:12px;text-align:center;color:var(--muted)}
.dow{display:block;font-size:11px;margin-top:2px}

/* Grouped Gantt */
.group{border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px}
.grouphead{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin-bottom:6px}
.groupmeta{color:var(--muted)}
.rail{position:relative;display:grid;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);gap:4px;margin-top:4px}
.cell{height:22px;background:var(--rail);border:1px solid var(--railBorder);border-radius:6px;box-sizing:border-box}
.pbar,.tbar{position:absolute;border-radius:8px;font-size:11px;display:flex;align-items:center;justify-content:center;white-space:nowrap}
.pbar{height:var(--proj-h); color:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1)}
.tbar{height:var(--task-h); color:#0f172a; border:1px solid var(--railBorder)}

/* Panels */
.panesTop{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
@media(max-width:1000px){.panesTop{grid-template-columns:1fr}}
.compact .row{gap:6px}
.compact .field{margin-top:6px}
.compact h3{margin:0 0 4px 0;font-size:15px}

/* Detail strip */
.strip-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.strip{display:flex;gap:8px;overflow-x:auto;padding-bottom:2px}
.dcard{min-width:340px;max-width:340px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px;flex:0 0 auto}
.dcard h4{margin:0 0 4px 0}
.drow{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.meta{font-size:12px;color:var(--muted)}
.inlineStat{display:flex;align-items:flex-end;gap:10px;width:100%}
.inlineStat .left{flex:1}
.inlineStat .progVal{width:40px}
.inlineStat .statSel{min-width:150px}
.hint{font-size:12px;color:var(--muted);padding:8px}

/* Sidebar */
#nav .chip{justify-content:flex-start;text-align:left}
#nav h2{margin:6px 0 6px;font-size:12px;color:var(--muted)}
.status-list{display:flex;flex-direction:column;gap:6px}
.status-chip{display:flex;align-items:center;gap:8px}
.flag{width:14px;height:10px;display:inline-block;position:relative}
.flag:before{content:"";position:absolute;left:0;top:2px;border-top:4px solid transparent;border-bottom:4px solid transparent;border-left:8px solid currentColor}
.flag:after{content:"";position:absolute;left:8px;top:2px;width:2px;height:8px;background:currentColor;border-radius:1px}

/* === ガント強制表示＋ズレ防止の基礎 === */
#groups{ display:block; }
.rail{ display:grid !important; position:relative !important; overflow:visible; }
.pbar,.tbar{ position:absolute; top:0; z-index:10; }
</style>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <h1>TaskSync Designer</h1>
    <div class="summary" id="summary"></div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span style="font-size:12px;color:var(--muted)">フィルタ:</span>
      <button class="chip" data-preset="all">すべて</button>
      <button class="chip" data-preset="today">今日</button>
      <button class="chip" data-preset="week">今週</button>
      <button class="chip" data-preset="overdue">期限切れ</button>
      <select id="clientFilter"><option value="all">全クライアント</option></select>
      <button id="theme" class="btn" title="テーマ切替">🌙/☀️</button>
    </div>

    <!-- 追加: 表示単位切替 -->
    <div class="row" style="width:100%; margin-top:6px">
      <span style="font-size:12px;color:var(--muted)">表示:</span>
      <button class="chip view-chip" data-view="day">日</button>
      <button class="chip view-chip" data-view="week">週</button>
      <button class="chip view-chip" data-view="month">月</button>

      <input id="qa-title" type="text" placeholder="タスク名（例：LP第2稿）" style="flex:1" />
      <input id="qa-project" list="projectList" type="text" placeholder="案件名（新規可）" style="width:200px" />
      <datalist id="projectList"></datalist>
      <input id="qa-client" list="clientList" type="text" placeholder="クライアント（新規可）" style="width:180px" />
      <datalist id="clientList"></datalist>
      <input id="qa-start" type="date" />
      <input id="qa-end" type="date" />
      <button id="qa-add" class="btn primary">新規作成</button>
      <button id="prep" class="btn">明日の準備</button>
      <button id="remindTonight" class="btn">今夜19時に通知</button>
      <button id="prev" class="btn small" title="前へ">◀︎</button>
      <button id="next" class="btn small" title="次へ">▶︎</button>
      <button id="reset" class="btn small warn" title="保存データ初期化">データ初期化</button>
      <button id="seed" class="btn small" title="サンプル投入">サンプル投入</button>
    </div>
  </div>

  <div class="layout">
    <aside class="card" id="nav">
      <h2>スマートビュー</h2>
      <nav style="display:flex;flex-direction:column;gap:6px">
        <button class="chip" data-nav="inbox">受信箱</button>
        <button class="chip" data-nav="today">今日</button>
        <button class="chip" data-nav="week">今週</button>
        <button class="chip" data-nav="overdue">期限切れ</button>
        <button class="chip" data-nav="done">完了</button>
      </nav>

      <h2>ステータス</h2>
      <div id="statusFilters" class="status-list"></div>

      <h2>クライアント</h2>
      <div id="navClients" style="display:flex;flex-direction:column;gap:6px">
        <button class="chip" data-client="all">全クライアント</button>
      </div>
    </aside>

    <div class="card daysCard"><div id="days" class="days"></div></div>
    <div class="main"><div id="groups" class="list"></div></div>

    <div class="detailArea">
      <div class="panesTop">
        <div class="card compact" id="panelClient">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>クライアント情報</h3>
            <select id="pClientSelect" title="対象クライアント" style="max-width:220px"></select>
          </div>
          <div class="row">
            <div style="flex:1 1 240px"><span class="lbl">組織名</span><input id="pCompany" type="text"></div>
            <div style="flex:1 1 200px"><span class="lbl">担当者名</span><input id="pPerson" type="text"></div>
          </div>
          <div class="row">
            <div style="flex:1 1 200px"><span class="lbl">電話番号</span><input id="pPhone" type="text"></div>
            <div style="flex:1 1 240px"><span class="lbl">メールアドレス</span><input id="pEmail" type="text"></div>
          </div>
          <div class="row">
            <div style="flex:2 1 340px"><span class="lbl">住所</span><input id="pAddress" type="text"></div>
            <div style="flex:1 1 200px"><span class="lbl">支払条件</span><input id="pTerms" type="text" placeholder="例：月末締め翌月末払い"></div>
          </div>
          <div class="row" style="justify-content:flex-end"><button id="pSave" class="btn">保存</button></div>
          <div class="lbl" style="margin-top:2px">※ 請求書の宛先に反映されます</div>
        </div>

        <div class="card compact" id="panelProject">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>案件概要</h3>
            <div class="row">
              <button id="btnInvoice" class="btn">請求書</button>
              <button id="btnGCal" class="btn">Googleカレンダー</button>
            </div>
          </div>
          <div class="row">
            <div style="flex:2 1 300px"><span class="lbl">案件名</span><input id="prjName" type="text"></div>
            <div class="row" style="flex:2 1 320px">
              <div style="flex:1 1 150px"><span class="lbl">開始日</span><input id="prjStart" type="date"></div>
              <div style="flex:1 1 150px"><span class="lbl">終了日</span><input id="prjEnd" type="date"></div>
            </div>
          </div>
          <div class="row">
            <div style="flex:2 1 420px"><span class="lbl">依頼事項</span><input id="prjNotes" type="text" placeholder="要点のみ（自由記述）"></div>
            <div style="flex:0 0 120px"><span class="lbl">進捗％</span><input id="prjProg" type="number" min="0" max="100" value="0"></div>
            <div style="flex:0 0 160px"><span class="lbl">ステータス</span>
              <select id="prjStatus"><option>Planned</option><option>In Progress</option><option>Blocked</option><option>Done</option></select>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end"><button id="prjSave" class="btn">保存</button></div>
        </div>
      </div>

      <div class="strip-wrap">
        <div class="strip-head">
          <h3 style="margin:0;font-size:15px">タスク詳細（ガントに表示中のみ）</h3>
          <button id="addDetailPanel" class="btn">＋詳細パネル</button>
        </div>
        <div id="detailStrip" class="strip"></div>
        <div id="detailHint" class="hint" style="display:none">※ 現在のガント（表示/フィルタ）に表示されているタスクのみ詳細カードを表示します。</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
/* ローカル日付固定（UTCズレ防止） */
function fmt(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function daysInMonth(d){ const dt=(d instanceof Date)?d:new Date(d); return new Date(dt.getFullYear(), dt.getMonth()+1, 0).getDate(); }
function parse(s){ return new Date(s+'T00:00:00'); }
function addDays(d,n){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()+n); }
function addMonths(d,n){ return new Date(d.getFullYear(), d.getMonth()+n, 1); }
function startOfWeek(d){ return addDays(d, -((d.getDay()+6)%7)); } // 月曜始まり
function pad(n){ return (n<10?'0':'')+n; }
function fmtTS(dt){ return dt.getFullYear()+'-'+pad(dt.getMonth()+1)+'-'+pad(dt.getDate())+' '+pad(dt.getHours())+':'+pad(dt.getMinutes()); }
function isYMD(s){ return typeof s==='string' && /^\d{4}-\d{2}-\d{2}$/.test(s); }
function safeParse(s){ if(!isYMD(s)) return null; const d=new Date(s+'T00:00:00'); return isNaN(d.getTime())?null:d; }
function daysDiff(a,b){ // a,b are Date at 00:00
  const ms=24*60*60*1000;
  return Math.floor((new Date(b.getFullYear(),b.getMonth(),b.getDate()) - new Date(a.getFullYear(),a.getMonth(),a.getDate()))/ms);
}

/* ===== State ===== */
var storeKey='tsd_persona_v351';
var themeKey='tsd_theme_v351';
var state={ monthAnchor:new Date(), preset:'all', client:'all', selectedId:null, statusFilter:'all', openDetails:[], tasks:[], clients:{}, projects:{}, view:'month' };

/* Colors */
var COLORS={ 'Planned':{proj:'#60a5fa',task:'#bfdbfe'}, 'In Progress':{proj:'#34d399',task:'#bbf7d0'}, 'Blocked':{proj:'#f87171',task:'#fecaca'}, 'Done':{proj:'#8b5cf6',task:'#ddd6fe'} };
var STATUS_ORDER=['Planned','In Progress','Blocked','Done'];

/* Demo seed */
var seed=(function(){ var a=new Date(); return [
  {id:'t1', title:'LPデザイン（構成案）', client:'Acme Co.', project:'ECサイト刷新', start:fmt(new Date(a.getFullYear(), a.getMonth(), 4)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 9)), progress:60, status:'In Progress', memos:['A/Bパターン提案済み'], createdAt:new Date().toISOString()},
  {id:'t2', title:'バナー3種', client:'Beta Studio', project:'キャンペーンA/W', start:fmt(new Date(a.getFullYear(), a.getMonth(), 5)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 12)), progress:30, status:'Planned', memos:['サイズ確定待ち'], createdAt:new Date().toISOString()},
  {id:'t3', title:'素材収集', client:'Beta Studio', project:'キャンペーンA/W', start:fmt(new Date(a.getFullYear(), a.getMonth(), 7)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 10)), progress:50, status:'In Progress', memos:[], createdAt:new Date().toISOString()}
];})();

/* Ensurers */
function ensureClient(name){ var key=(name&&name.trim())?name.trim():'(未設定)'; if
